@using Microsoft.EntityFrameworkCore
@inject ILocalStorageService LocalStorage
@inject ApplicationDbContext DB

@if (AccountReports is not null && AccountReports.Count > 0)
{
    <div class="col-xl-9">
        <div class="card">
            <div class="card-header align-items-center d-flex">
                <h4 class="card-title mb-0 flex-grow-1">Saldo das Contas</h4>

            </div><!-- end card header -->

            <div class="card-body">
                <div class="table-responsive table-card">
                    <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                        <thead class="text-muted table-light">
                            <tr>
                                <th scope="col">Descrição</th>
                                <th scope="col">Total Pago</th>
                                <th scope="col">Total Recebido</th>
                                <th scope="col">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var account in AccountReports)
                            {
                                <tr>
                                    <td>
                                        <h6 class="mb-0">@account.Description (Saldo Inicial: R$ @account.InitialBalance.ToString("N2"))</h6>
                                    </td>
                                    <td class="text-danger">R$ @account.TotalPayed.ToString("N2")</td>
                                    <td class="text-success">R$ @account.TotalReceived.ToString("N2")</td>
                                    <td>
                                        @if (account.Balance > 0)
                                        {
                                            <span class="badge bg-success-subtle text-success fw-bold">R$ @account.Balance.ToString("N2")</span>
                                        }
                                        else if (account.Balance == 0)
                                        {
                                            <span class="badge bg-info-subtle text-info fw-bold">R$ @account.Balance.ToString("N2")</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger-subtle text-danger fw-bold">R$ @account.Balance.ToString("N2")</span>
                                        }
                                    </td>
                                </tr>
                            }
                            
                        </tbody><!-- end tbody -->
                    </table><!-- end table -->
                </div>
            </div>
        </div> <!-- .card-->
    </div> <!-- .col-->
}
@code {
    private Company? Company;
    private List<AccountReportViewModel>? AccountReports { get; set; }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Company = await LocalStorage.GetItemAsync<Company>(AppConstants.LocalStorageCompany);
            if (Company is null)
            {
                return;
            }
            AccountReports = DB.Accounts
                .Where(a => a.CompanyId == Company!.Id)
                .Include(a=>a.FinancialTransactions)
                .Select(a => new AccountReportViewModel() { 
                    Description = a.Description, 
                    InitialBalance = a.Balance,
                    TotalPayed = a.FinancialTransactions!
                        .Where(x => x.TypeFinancialTransaction == TypeFinancialTransaction.Pay && x.AmountPaid.HasValue)
                        .Sum(y=>y.AmountPaid!.Value),
                    TotalReceived = a.FinancialTransactions!
                    .Where(x => x.TypeFinancialTransaction == TypeFinancialTransaction.Pay && x.AmountPaid.HasValue)
                    .Sum(y=>y.AmountPaid!.Value),
                    Balance = a.Balance 
                        + a.FinancialTransactions!
                            .Where(x => x.TypeFinancialTransaction == TypeFinancialTransaction.Receive && x.AmountPaid.HasValue)
                            .Sum(y=>y.AmountPaid!.Value)
                        - a.FinancialTransactions!
                            .Where(x => x.TypeFinancialTransaction == TypeFinancialTransaction.Pay && x.AmountPaid.HasValue)
                            .Sum(y=>y.AmountPaid!.Value)
                }).ToList();
            StateHasChanged();
        }
    }

    class AccountReportViewModel
    {
        public string Description { get; set; } = null!;
        public decimal TotalPayed { get; set; }
        public decimal TotalReceived { get; set; }
        public decimal Balance { get; set; }
        public decimal InitialBalance { get; set; }
    }
}